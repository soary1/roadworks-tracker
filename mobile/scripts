// Script pour v√©rifier les comptes bloqu√©s via Firebase Console ou CLI

// ============================================
// M√âTHODE 1 : Via Firebase Console (GUI)
// ============================================

/**
 * √âTAPES :
 * 1. Aller sur https://console.firebase.google.com/
 * 2. S√©lectionner le projet "roadworks-tracker"
 * 3. Cliquer sur "Firestore Database" (colonne gauche)
 * 4. Dans la collection, cliquer sur "loginAttempts"
 * 5. Chercher le document avec l'email du compte
 * 
 * VOUS VERREZ :
 * {
 *   "email": "user@example.com",
 *   "failedAttempts": 3,
 *   "isLocked": true,              ‚Üê ‚úÖ COMPTE BLOQU√â si true
 *   "lockedAt": "2026-01-27T10:30:00Z",
 *   "lastFailedAttempt": "2026-01-27T10:30:00Z",
 *   "userId": null
 * }
 */

// ============================================
// M√âTHODE 2 : Via Firebase CLI
// ============================================

/**
 * INSTALLATION :
 * npm install -g firebase-tools
 * firebase login
 * 
 * COMMANDES :
 */

// Voir tous les comptes bloqu√©s :
// firebase firestore:get --recursive collection/loginAttempts --project=roadworks-tracker

// Voir un compte sp√©cifique :
// firebase firestore:get collection/loginAttempts/email@example.com --project=roadworks-tracker

// ============================================
// M√âTHODE 3 : Via Script Node.js
// ============================================

/**
 * INSTALLATION :
 * 1. T√©l√©charger la cl√© de service depuis Firebase Console
 *    Settings ‚Üí Service Accounts ‚Üí Generate New Private Key
 * 2. Sauvegarder en tant que "firebase-key.json" dans le projet
 * 3. Ex√©cuter ce script
 */

import admin from 'firebase-admin';
import fs from 'fs';

// Initialiser Firebase Admin
const serviceAccount = JSON.parse(fs.readFileSync('./firebase-key.json', 'utf8'));

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: 'https://roadworks-tracker.firebaseio.com'
});

const db = admin.firestore();

/**
 * V√©rifier si un compte est bloqu√©
 */
async function isAccountBlockedViaAdmin(email: string): Promise<boolean> {
  try {
    const docRef = db.collection('loginAttempts').doc(email);
    const doc = await docRef.get();

    if (!doc.exists) {
      console.log(`‚ùå Aucun document trouv√© pour ${email}`);
      return false;
    }

    const data = doc.data();
    console.log(`üìã Donn√©es pour ${email}:`, data);

    if (data?.isLocked) {
      console.log(`üîí COMPTE BLOQU√â : ${email}`);
      console.log(`   - Tentatives √©chou√©es: ${data.failedAttempts}`);
      console.log(`   - Bloqu√© depuis: ${data.lockedAt?.toDate()}`);
      return true;
    } else {
      console.log(`‚úÖ Compte D√âBLOQU√â : ${email}`);
      return false;
    }
  } catch (error) {
    console.error('Erreur:', error);
    return false;
  }
}

/**
 * Lister tous les comptes bloqu√©s
 */
async function listAllBlockedAccounts(): Promise<string[]> {
  try {
    const snapshot = await db
      .collection('loginAttempts')
      .where('isLocked', '==', true)
      .get();

    const blockedEmails: string[] = [];

    if (snapshot.empty) {
      console.log('‚úÖ Aucun compte bloqu√©');
      return blockedEmails;
    }

    console.log(`üîí ${snapshot.size} compte(s) bloqu√©(s) trouv√©(s):\n`);

    snapshot.forEach((doc) => {
      const data = doc.data();
      blockedEmails.push(doc.id);
      console.log(`  üìß ${doc.id}`);
      console.log(`     - Tentatives: ${data.failedAttempts}/3`);
      console.log(`     - Bloqu√© depuis: ${data.lockedAt?.toDate()}`);
      console.log();
    });

    return blockedEmails;
  } catch (error) {
    console.error('Erreur:', error);
    return [];
  }
}

/**
 * D√©bloquer manuellement un compte
 */
async function unlockAccountViaAdmin(email: string): Promise<void> {
  try {
    const docRef = db.collection('loginAttempts').doc(email);
    await docRef.update({
      isLocked: false,
      failedAttempts: 0,
      lockedAt: null,
      lastFailedAttempt: null
    });
    console.log(`‚úÖ Compte d√©bloqu√© : ${email}`);
  } catch (error) {
    console.error('Erreur lors du d√©blocage:', error);
  }
}

/**
 * R√©initialiser compl√®tement les tentatives d'un compte
 */
async function resetAccountAttemptsViaAdmin(email: string): Promise<void> {
  try {
    const docRef = db.collection('loginAttempts').doc(email);
    await docRef.delete();
    console.log(`üîÑ Compte r√©initialis√© : ${email}`);
  } catch (error) {
    console.error('Erreur lors de la r√©initialisation:', error);
  }
}

// ============================================
// EXEMPLE D'UTILISATION
// ============================================

async function main() {
  console.log('üîç V√©rification des comptes bloqu√©s...\n');

  // 1. Voir tous les comptes bloqu√©s
  const blockedAccounts = await listAllBlockedAccounts();

  // 2. V√©rifier un compte sp√©cifique
  if (blockedAccounts.length > 0) {
    const email = blockedAccounts[0];
    console.log(`\nüìå V√©rification d√©taill√©e de ${email}`);
    await isAccountBlockedViaAdmin(email);

    // 3. D√©bloquer si n√©cessaire
    console.log(`\nüîì D√©blocage de ${email}`);
    await unlockAccountViaAdmin(email);

    // 4. V√©rifier √† nouveau
    console.log(`\n‚úÖ V√©rification apr√®s d√©blocage`);
    await isAccountBlockedViaAdmin(email);
  }

  admin.app().delete();
}

// D√©commenter pour ex√©cuter
// main().catch(console.error);

// ============================================
// EXPORT POUR UTILISATION DANS D'AUTRES SCRIPTS
// ============================================

export {
  isAccountBlockedViaAdmin,
  listAllBlockedAccounts,
  unlockAccountViaAdmin,
  resetAccountAttemptsViaAdmin
};
